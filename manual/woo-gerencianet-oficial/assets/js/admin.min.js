jQuery(document).ready(function() {
  jQuery("#tutorialGnBox").click(function() {
    jQuery("#tutorialGnBox").fadeOut();
  });
  jQuery("#woocommerce_gerencianet_oficial_billet_discount").mask("##0,00%", {reverse: true, onKeyPress: function(percentage){
      if (percentage.length>6) {
        jQuery("#woocommerce_gerencianet_oficial_billet_discount").val("99,99%");
      }
    }});
  jQuery("#woocommerce_gerencianet_oficial_billet_number_days").mask("999");

  jQuery("#showKeysProductionTutorial").click(function() {
    showGnTutorial("keysProduction");
  });

  jQuery("#showKeysDevelopmentTutorial").click(function() {
    showGnTutorial("keysDevelopment");
  });
  jQuery("#showPayeeCodeTutorial").click(function() {
    showGnTutorial("payeeCode");
  });

  function validadeProductionKeys() {
    jQuery('#validationProduction').html('Credenciais de Produção: Aguarde...').show();
    var data = {
        action: "woocommerce_gerencianet_validate_credentials",
        security: "woocommerce_gerencianet",
        client_id: jQuery("#woocommerce_gerencianet_oficial_client_id_production").val(),
        client_secret: jQuery("#woocommerce_gerencianet_oficial_client_secret_production").val(),
        mode: "production"
    };
    
    jQuery.ajax({
        type: "POST",
        url: ajax_url,
        data: data,
        success: function(response) {
          if (response=="true") {
            jQuery('#validationProduction').html('Credenciais de Produção: <B>CREDENCIAIS VÁLIDAS</B>.').show();
          } else {
            jQuery('#validationProduction').html('Credenciais de Produção: <B>INCORRETAS</B>. Por favor, verifique se você digitou corretamente suas credenciais ou entre em contato com a Gerencianet.').show();
            
          }
        },
        error: function(){
            alert("error ocurred");
        }
    });
  }

  jQuery("#verifyCredentials").click(function() {

      
  });

  function validadeDevelopmentKeys() {
    jQuery('#validationDevelopment').html('Credenciais de Desenvolvimento: Aguarde...').show();
    var data = {
        action: "woocommerce_gerencianet_validate_credentials",
        security: "woocommerce_gerencianet",
        client_id: jQuery("#woocommerce_gerencianet_oficial_client_id_development").val(),
        client_secret: jQuery("#woocommerce_gerencianet_oficial_client_secret_development").val(),
        mode: "development"
    };
    
    jQuery.ajax({
        type: "POST",
        url: ajax_url,
        data: data,
        success: function(response) {
          if (response=="true") {
            jQuery('#validationDevelopment').html('Credenciais de Desenvolvimento: <B>CREDENCIAIS VÁLIDAS</B>.').show();
          } else {
            jQuery('#validationDevelopment').html('Credenciais de Desenvolvimento: <B>INCORRETAS</B>. Por favor, verifique se você digitou corretamente suas credenciais ou entre em contato com a Gerencianet.').show();
          }
        },
        error: function(){
            alert("error ocurred");
        }
    });
  }

  var gnPayeeCodeVerify;
  var gnPayeeCodeValid;
  function validatePayeeCode() {

    jQuery('#validationPayeeCode').html('Identificador da conta: Aguarde...').show();

    var gn_api_payee_code = jQuery("#woocommerce_gerencianet_oficial_payee_code").val();

    if (gnPayeeCodeVerify) {
      if (gnPayeeCodeValid==gn_api_payee_code) {
        check();
      } else {
        jQuery('#validationPayeeCode').html('Identificador da conta: <B>O Identificador da Conta digitado foi alterado. Atualize a página e tente novamente.</B>.').show();
      }
    }

    
    var s=document.createElement('script');s.type='text/javascript';var v=parseInt(Math.random()*1000000);s.src='https://sandbox.gerencianet.com.br/v1/cdn/' + gn_api_payee_code + '/'+v;s.async=false;s.id=gn_api_payee_code;if(!document.getElementById(gn_api_payee_code)){document.getElementsByTagName('head')[0].appendChild(s);};$gn={validForm:true,processed:false,done:{},ready:function(fn){$gn.done=fn;}};
    
    $gn.ready(function(checkout) {
      gnPayeeCodeValid = gn_api_payee_code;
      gnPayeeCodeVerify = checkout;
      checkout.getInstallments(1000,'visa', function(error, response){
      if(error) {
        jQuery('#validationPayeeCode').html('Identificador da conta: <B>INCORRETO</B>. Por favor, verifique se você digitou corretamente o identificador da sua conta ou entre em contato com a Gerencianet.').show();
      } else {
        jQuery('#validationPayeeCode').html('Identificador da conta: <B>IDENTIFICADOR VÁLIDO</B>.').show();
      }
     });
    });

    function check()  {
      gnPayeeCodeVerify.getInstallments(1000,'visa', function(error, response){
      if(error) {
        jQuery('#validationPayeeCode').html('Identificador da conta: <B>INCORRETO</B>. Por favor, verifique se você digitou corretamente o identificador da sua conta ou entre em contato com a Gerencianet.').show();
      } else {
        jQuery('#validationPayeeCode').html('Identificador da conta: <B>IDENTIFICADOR VÁLIDO</B>.').show();
      }
     });
    }
  }

  jQuery("#verifyCredentials").click(function() {
    validadeDevelopmentKeys();
    validadeProductionKeys();
    validatePayeeCode();
  });

});

function showGnTutorial(tutorial) {
  switch(tutorial) {
    case "keysDevelopment": jQuery("#imgTutorial").attr("src", plugin_images_url + "gerencianet-exemplo-chaves-desenvolvimento.png"); break;
    case "keysProduction": jQuery("#imgTutorial").attr("src", plugin_images_url + "gerencianet-exemplo-chaves-producao.png"); break;
    case "payeeCode": jQuery("#imgTutorial").attr("src", plugin_images_url + "gerencianet-exemplo-identificador-conta.png"); break;
  }
  jQuery("#tutorialGnBox").fadeIn();
}